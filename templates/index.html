<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Text Overlay Tool - Flask App</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
            overflow-x: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1rem;
        }

        .main-container {
            display: flex;
            height: calc(100vh - 100px);
            gap: 20px;
            padding: 20px;
        }

        /* PDF Preview Section */
        .pdf-section {
            flex: 1;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .pdf-header {
            background: linear-gradient(90deg, #667eea, #764ba2);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pdf-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .page-nav {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .page-nav:hover {
            background: rgba(255,255,255,0.3);
        }

        .page-nav:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .upload-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px dashed #667eea;
            margin: 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(45deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: linear-gradient(45deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }

        .upload-content {
            text-align: center;
            padding: 40px;
        }

        .upload-icon {
            font-size: 4rem;
            color: #667eea;
            margin-bottom: 20px;
        }

        .pdf-viewer {
            flex: 1;
            position: relative;
            overflow: auto;
            background: #f8f9fa;
            display: none;
        }

        .pdf-canvas {
            display: block;
            margin: 20px auto;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            cursor: crosshair;
        }

        .text-overlay {
            position: absolute;
            background: rgba(102, 126, 234, 0.8);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            pointer-events: none;
            transform: translate(-50%, -100%);
            white-space: nowrap;
        }

        /* Configuration Section */
        .config-section {
            flex: 1;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .config-header {
            background: linear-gradient(90deg, #764ba2, #667eea);
            color: white;
            padding: 15px 20px;
        }

        .config-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .section {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #e1e5e9;
            border-radius: 10px;
            background: #f8f9fa;
        }

        .section h3 {
            margin-bottom: 15px;
            color: #667eea;
            font-size: 1.2rem;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 120px;
            font-family: 'Courier New', monospace;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .btn-block {
            width: 100%;
            margin-bottom: 10px;
        }

        .variable-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
        }

        .variable-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .coordinate-display {
            background: #e9ecef;
            padding: 8px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .config-output {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .click-instruction {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 0.9rem;
        }

        .current-page-indicator {
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            max-width: 300px;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
        }

        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        .notification.success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .notification.error {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .loading.show {
            display: block;
        }

        @media (max-width: 1200px) {
            .main-container {
                flex-direction: column;
                height: auto;
            }
            
            .pdf-section, .config-section {
                flex: none;
                min-height: 500px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🚀 PDF Text Overlay Tool </h1>
        <p>Upload, configure, and process PDF text overlays with real-time preview</p>
    </div>

    <div class="main-container">
        <!-- PDF Preview Section -->
        <div class="pdf-section">
            <div class="pdf-header">
                <h3>📖 PDF Preview</h3>
                <div class="pdf-controls" id="pdfControls" style="display: none;">
                    <button class="page-nav" id="prevPage">← Previous</button>
                    <span class="current-page-indicator" id="pageInfo">Page 1 of 1</span>
                    <button class="page-nav" id="nextPage">Next →</button>
                </div>
            </div>
            
            <div class="upload-area" id="uploadArea">
                <div class="upload-content">
                    <div class="upload-icon">📁</div>
                    <h3>Upload Your PDF</h3>
                    <p>Drag and drop a PDF file here or click to browse</p>
                    <input type="file" id="pdfInput" accept=".pdf" style="display: none;">
                </div>
            </div>

            <div class="pdf-viewer" id="pdfViewer">
                <div class="click-instruction">
                    💡 Click anywhere on the PDF to add text overlay positions
                </div>
                <canvas id="pdfCanvas" class="pdf-canvas"></canvas>
            </div>

            <div class="loading" id="uploadLoading">
                <div>📤 Uploading PDF...</div>
            </div>
        </div>

        <!-- Configuration Section -->
        <div class="config-section">
            <div class="config-header">
                <h3>⚙️ Configuration & Processing</h3>
            </div>
            
            <div class="config-content">
                <!-- Sample Data Section -->
                <div class="section">
                    <h3>📝 Sample Data</h3>
                    <div class="form-group">
                        <label>Sample JSON Data (for overlay processing):</label>
                        <textarea class="form-control" id="sampleData" placeholder='Enter sample data in JSON format, e.g.:
{
  "name": "John Doe",
  "email": "john@example.com",
  "date": "2024-01-15"
}'></textarea>
                    </div>
                    <button class="btn btn-success btn-block" id="prefillBtn">✨ Prefill Data Based on Config</button>
                </div>

                <!-- Variables Section -->
                <div class="section">
                    <h3>🎯 Text Variables</h3>
                    <div id="variablesList">
                        <!-- Variables will be added here dynamically -->
                    </div>
                    <button class="btn btn-secondary btn-block" id="addVariableBtn">+ Add Variable</button>
                </div>

                <!-- Processing Section -->
                <div class="section">
                    <h3>🔧 Process PDF</h3>
                    <button class="btn btn-block" id="processBtn" disabled>🚀 Process PDF with Overlays</button>
                    <div class="loading" id="processLoading">
                        <div>⚙️ Processing PDF...</div>
                    </div>
                    <div id="downloadSection" style="display: none; margin-top: 15px;">
                        <button class="btn btn-success btn-block" id="downloadBtn">💾 Download Processed PDF</button>
                    </div>
                </div>

                <!-- Configuration Output -->
                <div class="section">
                    <h3>📋 Generated Configuration</h3>
                    <div style="background: #e3f2fd; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 0.85rem;">
                        💡 <strong>Note:</strong> Page numbers in config are 0-based (Page 1 → 0, Page 2 → 1, etc.)
                    </div>
                    <div class="config-output" id="configOutput">Click on the PDF to start adding variables...</div>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button class="btn" id="copyConfigBtn" style="flex: 1;">📋 Copy Config</button>
                        <button class="btn btn-secondary" id="saveConfigBtn" style="flex: 1;">💾 Save Config</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification area -->
    <div id="notification" class="notification"></div>

    <script>
        // Global variables
        let pdfDoc = null;
        let currentPage = 1;
        let totalPages = 0;
        let pdfCanvas = null;
        let pdfCtx = null;
        let variables = [];
        let scale = 1.5;
        let pdfUploaded = false;
        let processedFilename = null;
        let pdfPageDimensions = {}; // Store actual PDF page dimensions

        // Initialize PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // DOM elements
        const uploadArea = document.getElementById('uploadArea');
        const pdfInput = document.getElementById('pdfInput');
        const pdfViewer = document.getElementById('pdfViewer');
        const pdfControls = document.getElementById('pdfControls');
        pdfCanvas = document.getElementById('pdfCanvas');
        pdfCtx = pdfCanvas.getContext('2d');
        const pageInfo = document.getElementById('pageInfo');
        const prevPageBtn = document.getElementById('prevPage');
        const nextPageBtn = document.getElementById('nextPage');
        const variablesList = document.getElementById('variablesList');
        const addVariableBtn = document.getElementById('addVariableBtn');
        const configOutput = document.getElementById('configOutput');
        const copyConfigBtn = document.getElementById('copyConfigBtn');
        const saveConfigBtn = document.getElementById('saveConfigBtn');
        const sampleData = document.getElementById('sampleData');
        const prefillBtn = document.getElementById('prefillBtn');
        const processBtn = document.getElementById('processBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const uploadLoading = document.getElementById('uploadLoading');
        const processLoading = document.getElementById('processLoading');
        const downloadSection = document.getElementById('downloadSection');
        const notification = document.getElementById('notification');

        // Event listeners
        uploadArea.addEventListener('click', () => pdfInput.click());
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('drop', handleDrop);
        pdfInput.addEventListener('change', handleFileSelect);
        pdfCanvas.addEventListener('click', handleCanvasClick);
        prevPageBtn.addEventListener('click', () => changePage(-1));
        nextPageBtn.addEventListener('click', () => changePage(1));
        addVariableBtn.addEventListener('click', addVariable);
        copyConfigBtn.addEventListener('click', copyConfiguration);
        saveConfigBtn.addEventListener('click', saveConfiguration);
        prefillBtn.addEventListener('click', prefillSampleData);
        processBtn.addEventListener('click', processDocument);
        downloadBtn.addEventListener('click', downloadProcessedPDF);

        // Utility functions
        function showNotification(message, type = 'success') {
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        function showLoading(element) {
            element.classList.add('show');
        }

        function hideLoading(element) {
            element.classList.remove('show');
        }

        // File handling
        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                uploadPDF(files[0]);
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                uploadPDF(file);
            }
        }

        // PDF upload and processing
        async function uploadPDF(file) {
            if (file.size > 16 * 1024 * 1024) {
                showNotification('File too large. Maximum size is 16MB.', 'error');
                return;
            }

            showLoading(uploadLoading);
            
            const formData = new FormData();
            formData.append('pdf', file);

            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    showNotification(result.message);
                    await loadPDFForPreview(file);
                    pdfUploaded = true;
                    processBtn.disabled = false;
                } else {
                    showNotification(result.error, 'error');
                }
            } catch (error) {
                showNotification('Upload failed: ' + error.message, 'error');
            } finally {
                hideLoading(uploadLoading);
            }
        }

        async function loadPDFForPreview(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                pdfDoc = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                totalPages = pdfDoc.numPages;
                currentPage = 1;
                
                // Get actual PDF page dimensions from server
                await getPDFDimensions();
                
                uploadArea.style.display = 'none';
                pdfViewer.style.display = 'block';
                pdfControls.style.display = 'flex';
                
                await renderPage(currentPage);
                updatePageInfo();
                variables = [];
                updateVariablesList();
                updateConfiguration();
            } catch (error) {
                showNotification('Error loading PDF preview: ' + error.message, 'error');
            }
        }

        async function getPDFDimensions() {
            try {
                const response = await fetch('/api/pdf-info');
                const result = await response.json();
                
                if (result.success) {
                    // Store page dimensions for coordinate conversion
                    result.pages.forEach(page => {
                        pdfPageDimensions[page.page] = {
                            width: page.width,
                            height: page.height
                        };
                    });
                } else {
                    console.warn('Could not get PDF dimensions:', result.error);
                    // Use default dimensions if we can't get actual ones
                    for (let i = 1; i <= totalPages; i++) {
                        pdfPageDimensions[i] = { width: 612, height: 792 }; // US Letter
                    }
                }
            } catch (error) {
                console.warn('Error getting PDF dimensions:', error);
                // Use default dimensions
                for (let i = 1; i <= totalPages; i++) {
                    pdfPageDimensions[i] = { width: 612, height: 792 };
                }
            }
        }

        async function renderPage(pageNum) {
            try {
                const page = await pdfDoc.getPage(pageNum);
                const viewport = page.getViewport({scale: scale});
                
                pdfCanvas.width = viewport.width;
                pdfCanvas.height = viewport.height;
                
                const renderContext = {
                    canvasContext: pdfCtx,
                    viewport: viewport
                };
                
                await page.render(renderContext).promise;
                renderTextOverlays();
            } catch (error) {
                console.error('Error rendering page:', error);
            }
        }

        function renderTextOverlays() {
            const existingOverlays = pdfViewer.querySelectorAll('.text-overlay');
            existingOverlays.forEach(overlay => overlay.remove());

            const currentPageVars = variables.filter(v => v.page === currentPage);
            currentPageVars.forEach(variable => {
                // Convert PDF coordinates back to canvas coordinates for display
                const canvasCoords = pdfToCanvasCoordinates(variable.x, variable.y, currentPage);
                
                const overlay = document.createElement('div');
                overlay.className = 'text-overlay';
                overlay.textContent = `${variable.name} (${variable.x}, ${variable.y})`;
                overlay.style.left = canvasCoords.x + 'px';
                overlay.style.top = canvasCoords.y + 'px';
                pdfViewer.appendChild(overlay);
            });
        }

        function changePage(direction) {
            const newPage = currentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderPage(currentPage);
                updatePageInfo();
                renderTextOverlays();
            }
        }

        function updatePageInfo() {
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            prevPageBtn.disabled = currentPage <= 1;
            nextPageBtn.disabled = currentPage >= totalPages;
        }

        function handleCanvasClick(e) {
            const rect = pdfCanvas.getBoundingClientRect();
            const canvasX = Math.round(e.clientX - rect.left);
            const canvasY = Math.round(e.clientY - rect.top);
            
            // Convert canvas coordinates to PDF coordinates
            const pdfCoords = canvasToPDFCoordinates(canvasX, canvasY, currentPage);
            
            addVariableAtPosition(pdfCoords.x, pdfCoords.y, currentPage);
        }

        function canvasToPDFCoordinates(canvasX, canvasY, pageNum) {
            // Get the current page dimensions
            const page = pdfDoc.getPage(pageNum);
            
            // Get actual PDF page dimensions
            const pdfPageDim = pdfPageDimensions[pageNum] || { width: 612, height: 792 };
            
            // Calculate the scale factors
            const scaleX = pdfPageDim.width / pdfCanvas.width;
            const scaleY = pdfPageDim.height / pdfCanvas.height;
            
            // Convert canvas coordinates to PDF coordinates
            const pdfX = Math.round(canvasX * scaleX);
            // PDF coordinate system has origin at bottom-left, canvas at top-left
            const pdfY = Math.round(pdfPageDim.height - (canvasY * scaleY));
            
            return { x: pdfX, y: pdfY };
        }

        function pdfToCanvasCoordinates(pdfX, pdfY, pageNum) {
            // Convert PDF coordinates back to canvas coordinates for overlay display
            const pdfPageDim = pdfPageDimensions[pageNum] || { width: 612, height: 792 };
            
            const scaleX = pdfCanvas.width / pdfPageDim.width;
            const scaleY = pdfCanvas.height / pdfPageDim.height;
            
            const canvasX = Math.round(pdfX * scaleX);
            const canvasY = Math.round((pdfPageDim.height - pdfY) * scaleY);
            
            return { x: canvasX, y: canvasY };
        }

        function addVariableAtPosition(x, y, page) {
            const variableName = `var_${variables.length + 1}`;
            const variable = {
                name: variableName,
                x: x,
                y: y,
                page: page,
                fontSize: 12
            };
            
            variables.push(variable);
            updateVariablesList();
            updateConfiguration();
            renderTextOverlays();
        }

        function addVariable() {
            // Get center coordinates of current page in PDF coordinate system
            const pdfPageDim = pdfPageDimensions[currentPage] || { width: 612, height: 792 };
            const centerX = Math.round(pdfPageDim.width / 2);
            const centerY = Math.round(pdfPageDim.height / 2);
            
            const variable = {
                name: `var_${variables.length + 1}`,
                x: centerX,
                y: centerY,
                page: currentPage,
                fontSize: 12
            };
            
            variables.push(variable);
            updateVariablesList();
            updateConfiguration();
            renderTextOverlays();
        }

        function removeVariable(index) {
            variables.splice(index, 1);
            updateVariablesList();
            updateConfiguration();
            renderTextOverlays();
        }

        function updateVariable(index, field, value) {
            if (variables[index]) {
                variables[index][field] = field === 'fontSize' || field === 'x' || field === 'y' || field === 'page' ? 
                    parseInt(value) || 0 : value;
                updateConfiguration();
                if (field === 'x' || field === 'y' || field === 'page') {
                    renderTextOverlays();
                }
            }
        }

        function updateVariablesList() {
            variablesList.innerHTML = '';
            
            variables.forEach((variable, index) => {
                const div = document.createElement('div');
                div.className = 'variable-item';
                div.innerHTML = `
                    <div class="variable-header">
                        <strong>Variable ${index + 1}</strong>
                        <button class="remove-btn" onclick="removeVariable(${index})">Remove</button>
                    </div>
                    <div class="form-group">
                        <label>Variable Name:</label>
                        <input type="text" class="form-control" value="${variable.name}" 
                               onchange="updateVariable(${index}, 'name', this.value)">
                    </div>
                    <div class="coordinate-display">
                        Display Page: ${variable.page} → Config Page: ${variable.page - 1} (0-based)
                        <br>PDF Coords: X: ${variable.x} | Y: ${variable.y}
                        <br><small style="color: #6c757d;">pdf_text_overlay uses 0-based page numbering</small>
                    </div>
                    <div class="form-group">
                        <label>Page Number:</label>
                        <input type="number" class="form-control" value="${variable.page}" min="1" max="${totalPages || 999}"
                               onchange="updateVariable(${index}, 'page', this.value)">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <div class="form-group" style="flex: 1;">
                            <label>X Coordinate:</label>
                            <input type="number" class="form-control" value="${variable.x}"
                                   onchange="updateVariable(${index}, 'x', this.value)">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>Y Coordinate:</label>
                            <input type="number" class="form-control" value="${variable.y}"
                                   onchange="updateVariable(${index}, 'y', this.value)">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Font Size:</label>
                        <input type="number" class="form-control" value="${variable.fontSize}" min="6" max="72"
                               onchange="updateVariable(${index}, 'fontSize', this.value)">
                    </div>
                `;
                variablesList.appendChild(div);
            });
        }

        function updateConfiguration() {
            if (variables.length === 0) {
                configOutput.textContent = 'Click on the PDF to start adding variables...';
                return;
            }

            const pageGroups = {};
            variables.forEach(variable => {
                // Convert 1-based display page to 0-based page for pdf_text_overlay
                const zeroBasedPage = variable.page - 1;
                if (!pageGroups[zeroBasedPage]) {
                    pageGroups[zeroBasedPage] = [];
                }
                pageGroups[zeroBasedPage].push({
                    name: variable.name,
                    "x-coordinate": variable.x,
                    "y-coordinate": variable.y,
                    font_size: variable.fontSize
                });
            });

            const configuration = Object.keys(pageGroups).map(page => ({
                page_number: parseInt(page), // This will be 0-based
                variables: pageGroups[page]
            }));

            configOutput.textContent = JSON.stringify(configuration, null, 2);
        }

        function copyConfiguration() {
            if (configOutput.textContent && configOutput.textContent !== 'Click on the PDF to start adding variables...') {
                navigator.clipboard.writeText(configOutput.textContent).then(() => {
                    showNotification('Configuration copied to clipboard!');
                });
            }
        }

        function saveConfiguration() {
            if (variables.length === 0) {
                showNotification('No configuration to save', 'error');
                return;
            }

            const configName = prompt('Enter configuration name:', `config_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}`);
            if (!configName) return;

            const pageGroups = {};
            variables.forEach(variable => {
                // Convert 1-based display page to 0-based page for pdf_text_overlay
                const zeroBasedPage = variable.page - 1;
                if (!pageGroups[zeroBasedPage]) {
                    pageGroups[zeroBasedPage] = [];
                }
                pageGroups[zeroBasedPage].push({
                    name: variable.name,
                    "x-coordinate": variable.x,
                    "y-coordinate": variable.y,
                    font_size: variable.fontSize
                });
            });

            const configuration = Object.keys(pageGroups).map(page => ({
                page_number: parseInt(page), // This will be 0-based
                variables: pageGroups[page]
            }));

            fetch('/api/save-config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: configName,
                    configuration: configuration
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showNotification(result.message);
                } else {
                    showNotification(result.error, 'error');
                }
            })
            .catch(error => {
                showNotification('Failed to save configuration: ' + error.message, 'error');
            });
        }

        function prefillSampleData() {
            const variableNames = variables.map(v => v.name);
            if (variableNames.length === 0) {
                showNotification('Please add some variables first by clicking on the PDF.', 'error');
                return;
            }

            const sampleObj = {};
            variableNames.forEach(name => {
                if (name.toLowerCase().includes('name')) {
                    sampleObj[name] = 'John Doe';
                } else if (name.toLowerCase().includes('email')) {
                    sampleObj[name] = 'john.doe@example.com';
                } else if (name.toLowerCase().includes('date')) {
                    sampleObj[name] = new Date().toISOString().split('T')[0];
                } else if (name.toLowerCase().includes('phone')) {
                    sampleObj[name] = '+1-234-567-8900';
                } else if (name.toLowerCase().includes('address')) {
                    sampleObj[name] = '123 Main St, City, State 12345';
                } else if (name.toLowerCase().includes('company')) {
                    sampleObj[name] = 'Example Company Inc.';
                } else {
                    sampleObj[name] = `Sample ${name}`;
                }
            });

            sampleData.value = JSON.stringify(sampleObj, null, 2);
            showNotification('Sample data generated based on variable names!');
        }

        async function processDocument() {
            if (!pdfUploaded) {
                showNotification('Please upload a PDF first', 'error');
                return;
            }

            if (variables.length === 0) {
                showNotification('Please add some variables first', 'error');
                return;
            }

            let parsedSampleData;
            try {
                parsedSampleData = JSON.parse(sampleData.value || '{}');
            } catch (error) {
                showNotification('Invalid JSON in sample data', 'error');
                return;
            }

            showLoading(processLoading);
            processBtn.disabled = true;

            const pageGroups = {};
            variables.forEach(variable => {
                // Convert 1-based display page to 0-based page for pdf_text_overlay
                const zeroBasedPage = variable.page - 1;
                if (!pageGroups[zeroBasedPage]) {
                    pageGroups[zeroBasedPage] = [];
                }
                pageGroups[zeroBasedPage].push({
                    name: variable.name,
                    "x-coordinate": variable.x,
                    "y-coordinate": variable.y,
                    font_size: variable.fontSize
                });
            });

            const configuration = Object.keys(pageGroups).map(page => ({
                page_number: parseInt(page), // This will be 0-based
                variables: pageGroups[page]
            }));

            try {
                const response = await fetch('/api/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        configuration: configuration,
                        sample_data: parsedSampleData
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('PDF processed successfully!');
                    processedFilename = result.output_filename;
                    downloadSection.style.display = 'block';
                } else {
                    showNotification(result.error, 'error');
                }
            } catch (error) {
                showNotification('Processing failed: ' + error.message, 'error');
            } finally {
                hideLoading(processLoading);
                processBtn.disabled = false;
            }
        }

        function downloadProcessedPDF() {
            if (!processedFilename) {
                showNotification('No processed file available', 'error');
                return;
            }

            window.open(`/api/download/${processedFilename}`, '_blank');
        }

        // Initialize with sample data
        sampleData.value = `{
  "name": "John Doe",
  "email": "john.doe@example.com",
  "date": "2024-01-15",
  "company": "Example Corp",
  "position": "Software Engineer"
}`;
    </script>
</body>
</html>